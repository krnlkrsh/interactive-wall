<%- include('partials_head') %>
  <main class="container">
    <h1>Moderation</h1>

<section>
  <h2>Ghost layer settings</h2>
  <form method="post" action="/admin/ghost-settings" class="ghost-settings">
    <label style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span>Ghost limit</span>
      <input type="number" name="ghost_limit" min="0" max="4000" value="<%= ghost_limit %>" style="width:120px;">
      <span>Font size</span>
      <input type="number" name="ghost_fontsize" min="1" value="<%= ghost_fontsize %>" style="width:120px;">
      <button class="btn" type="submit">Save</button>
    </label>
    <small>These only affect the ghost canvas layer, not moderation lists.</small>
  </form>
</section>

    <section>
      <h2>Pending (<span id="pending-count"><%= pending.length %></span>)</h2>

     <form id="bulk-form" method="post" action="/admin/bulk" class="bulk-actions">
        <input type="hidden" name="ids" id="bulk-ids" value="">
        <input type="hidden" name="action" id="bulk-action" value="approve">
        <button class="btn" type="button" onclick="bulk('approve')">Bulk Approve</button>
        <button class="btn danger" type="button" onclick="bulk('reject')">Bulk Reject</button>
      </form>

      <div class="grid" id="pending-grid">
        <% pending.forEach(p => { const reason = p.flag_reason || (p.auto_flagged ? "profanity" : ""); %>
          <div class="card" data-id="<%= p.id %>">
            <div class="meta">
              <small>#<%= p.id %> • <%= p.created_at %>
                <% if (p.auto_flagged) { %>
                  • <span class="flag">auto-flagged: <%= reason %></span>
                <% } %>
              </small>
            </div>

            <pre class="content"><%= p.text %></pre>

            <form class="actions" method="post" action="/admin/approve/<%= p.id %>">
              <button class="btn small" type="submit">Approve</button>
            </form>

            <form class="actions" method="post" action="/admin/reject/<%= p.id %>">
              <button class="btn small danger" type="submit">Reject</button>
            </form>

            <label class="select">
              <input type="checkbox" class="sel" value="<%= p.id %>"> select
            </label>
          </div>
        <% }) %>
      </div>
    </section>

    <section>
      <h2>Recently approved</h2>

      <div class="grid" id="approved-grid">
        <% approved.forEach(a => { %>
          <div class="card ok" data-id="<%= a.id %>">
            <div class="meta">
              <small>#<%= a.id %> • <%= a.created_at %></small>
            </div>

            <pre class="content"><%= a.text %></pre>

            <form class="actions" method="post" action="/admin/remove/<%= a.id %>">
              <button
                class="btn small danger"
                type="submit"
                onclick="return confirm('Remove this post from the wall?');">
                  Remove from wall
              </button>
            </form>
          </div>
        <% }) %>
      </div>
    </section>
  </main>

  <script>
    function bulk(action) {
      const ids = Array.from(document.querySelectorAll('.sel:checked')).map(x => x.value);
      document.getElementById('bulk-ids').value = ids.join(',');
      document.getElementById('bulk-action').value = action;
      document.getElementById('bulk-form').submit();
    }

    // ---- Auto-refresh moderation state (no page reload) ----
    let lastSig = null;

    function getSelectedIds() {
      return new Set(Array.from(document.querySelectorAll('.sel:checked')).map(x => String(x.value)));
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      }[c]));
    }

    function renderPending(pending) {
      const sel = getSelectedIds();
      document.getElementById('pending-count').textContent = String(pending.length);

      const grid = document.getElementById('pending-grid');
      grid.innerHTML = pending.map(p => {
        const reason = p.flag_reason || (p.auto_flagged ? "profanity" : "");
        const flagged = p.auto_flagged
          ? ` • <span class="flag">auto-flagged: ${escapeHtml(reason)}</span>`
          : '';

        const checked = sel.has(String(p.id)) ? 'checked' : '';

        return `
          <div class="card" data-id="${escapeHtml(String(p.id))}">
            <div class="meta">
              <small>#${escapeHtml(String(p.id))} • ${escapeHtml(p.created_at)}${flagged}</small>
            </div>

            <pre class="content">${escapeHtml(p.text)}</pre>

            <form class="actions" method="post" action="/admin/approve/${escapeHtml(String(p.id))}">
              <button class="btn small" type="submit">Approve</button>
            </form>

            <form class="actions" method="post" action="/admin/reject/${escapeHtml(String(p.id))}">
              <button class="btn small danger" type="submit">Reject</button>
            </form>

            <label class="select">
              <input type="checkbox" class="sel" value="${escapeHtml(String(p.id))}" ${checked}> select
            </label>
          </div>
        `;
      }).join('');
    }

    function renderApproved(approved) {
      const grid = document.getElementById('approved-grid');
      grid.innerHTML = approved.map(a => {
        return `
          <div class="card ok" data-id="${escapeHtml(String(a.id))}">
            <div class="meta">
              <small>#${escapeHtml(String(a.id))} • ${escapeHtml(a.created_at)}</small>
            </div>

            <pre class="content">${escapeHtml(a.text)}</pre>

            <form class="actions" method="post" action="/admin/remove/${escapeHtml(String(a.id))}">
              <button class="btn small danger" type="submit" onclick="return confirm('Remove this post from the wall?');">
                Remove from wall
              </button>
            </form>
          </div>
        `;
      }).join('');
    }

    async function pollAdminState() {
      try {
        const res = await fetch('/api/admin/state?_=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) return;

        const data = await res.json();
        const sig = data.sig || null;

        // If signature is unchanged, do nothing
        if (sig && sig === lastSig) return;
        lastSig = sig;

        renderPending(data.pending || []);
        renderApproved(data.approved || []);
      } catch (e) {
        // silent
      }
    }

    // start polling
    setInterval(pollAdminState, 2000);
    pollAdminState();
  </script>
<%- include('partials_foot') %>
 
