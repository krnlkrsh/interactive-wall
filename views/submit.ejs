<%- include('partials_head') %>
  <main class="container">
    <h1 class="title">Share a few words</h1>

    <div class="card" style="margin-bottom:14px;">
      <div style="font-weight:600; margin-bottom:6px;">Write a message of love and gratitude to a loved one below</div>
      <div style="margin-bottom:10px;">Keep your entries kind and respectful</div>

      <div dir="rtl" style="font-weight:600; margin-bottom:6px;">اكتب رسالة حب وامتنان لشخص عزيز عليك هنا</div>
      <div dir="rtl">تذكّر أن تكون كلماتك لطيفة ومحترمة</div>
    </div>

    <form class="card" method="post" action="/submit" id="submitForm">
      <label for="text">Your words</label>
      <textarea
        id="text"
        name="text"
        rows="6"
        maxlength="300"
        placeholder="Write a short thought, feeling, or phrase…"></textarea>

      <div class="hint">
        <span id="charHint">Max 300 characters. Keep it kind.</span>
        <span id="charCount" style="float:right;">0/300</span>
      </div>

      <div
  class="cf-turnstile"
  data-sitekey="<%= TURNSTILE_SITE_KEY %>"
  style="margin-top:12px;">
</div>
      <button class="btn" type="submit" id="submitBtn">Send</button>
    </form>
  </main>

  <script>
    // Tiny client-side safeguards + counter + prevent double-submit
    const form = document.getElementById('submitForm');
    const ta = document.getElementById('text');
    const countEl = document.getElementById('charCount');
    const btn = document.getElementById('submitBtn');
    const MAX = 300;

    let submitting = false;

    function updateCount() {
      countEl.textContent = `${ta.value.length}/${MAX}`;
    }

    ta.addEventListener('input', () => {
      // Limit consecutive spaces
      let v = ta.value.replace(/\s{3,}/g, '  ');

      // Limit line breaks
      const lines = v.split(/\n/).slice(0, 12).join('\n');

      // Enforce max chars (UI-level)
      const clipped = lines.slice(0, MAX);

      if (clipped !== ta.value) ta.value = clipped;
      updateCount();
    });

    // Prevent accidental double-submit
    form.addEventListener('submit', (e) => {
      if (submitting) {
        e.preventDefault();
        return;
      }

      // Optional: block empty submissions client-side too
      if (!ta.value || !ta.value.trim()) {
        e.preventDefault();
        return;
      }

      submitting = true;

      // Lock UI immediately
      btn.disabled = true;
      btn.dataset.originalText = btn.textContent;
      btn.textContent = 'Sending…';
      ta.readOnly = true;

      // If the network fails and user stays on page, unlock after a bit
      window.setTimeout(() => {
        if (!document.hidden) {
          submitting = false;
          btn.disabled = false;
          btn.textContent = btn.dataset.originalText || 'Send';
          ta.readOnly = false;
        }
      }, 15000);
    });

    updateCount();
  </script>
<%- include('partials_foot') %>

